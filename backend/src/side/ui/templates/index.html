<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidelith // God-View Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #121212;
            --border: #333;
            --primary: #00f3ff; /* Cyan for Code */
            --secondary: #ffb000; /* Amber for Intent */
            --accent: #ff0055; /* Red for Violations/Security */
            --text-main: #e0e0e0;
            --text-dim: #888;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .brand {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: var(--primary);
        }

        .brand span {
            color: var(--text-main);
        }

        main {
            display: flex;
            height: calc(100% - 60px);
        }

        #graph-container {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%);
        }

        #sidebar {
            width: 400px;
            border-left: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .node-details {
            display: none;
        }

        .node-details.active {
            display: block;
        }

        .property-row {
            margin-bottom: 15px;
        }

        .property-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .property-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .tag-symbol { background: var(--primary); color: #000; }
        .tag-intent { background: var(--secondary); color: #000; }
        .tag-finding { background: var(--accent); color: #fff; }
        .tag-module { background: #555; color: #fff; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .stat-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--border);
        }

        .stat-val {
            font-size: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        /* SVG Graph Styles */
        .node circle { stroke: #000; stroke-width: 1.5px; }
        .link { stroke: #555; stroke-opacity: 0.6; stroke-width: 1px; fill: none; }
        .node text { font-family: 'JetBrains Mono'; font-size: 10px; pointer-events: none; }
    </style>
</head>
<body>
    <header>
        <div class="brand">SIDE<span>LITH</span> // GOD-VIEW</div>
    </header>

    <main>
        <div id="graph-container">
            <svg id="viz" width="100%" height="100%"></svg>
        </div>

        <div id="sidebar">
            <div class="panel-title">Forensic Inspector</div>
            
            <div id="welcome-msg" class="active">
                <p style="color: var(--text-dim); font-size: 0.9rem;">Select a node in the Logic Fabric to inspect its strategic trajectory and sovereign audit logs.</p>
            </div>

            <div id="node-inspector" class="node-details">
                <div id="node-tag" class="tag">TYPE</div>
                <div class="property-row">
                    <div class="property-label">Identifier</div>
                    <div id="node-id" class="property-value">-</div>
                </div>
                <div class="property-row" id="prop-content-row">
                    <div class="property-label">Payload</div>
                    <div id="node-content" class="property-value">-</div>
                </div>
                <div class="property-row">
                    <div class="property-label">Metadata</div>
                    <pre id="node-meta" style="font-size: 0.75rem; color: var(--text-dim); background: #222; padding: 10px; border-radius: 5px; overflow-x: auto;"></pre>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div id="stat-nodes" class="stat-val">0</div>
                    <div class="stat-label">Logic Objects</div>
                </div>
                <div class="stat-box">
                    <div id="stat-links" class="stat-val">0</div>
                    <div class="stat-label">Forensic Links</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const svg = d3.select("#viz");
        const container = document.getElementById("graph-container");
        
        async function loadData() {
            const graphRes = await fetch('/api/graph');
            const data = await graphRes.json();
            
            const statsRes = await fetch('/api/stats');
            const stats = await statsRes.json();

            document.getElementById("stat-nodes").innerText = stats.total_objects;
            document.getElementById("stat-links").innerText = stats.total_links;

            renderGraph(data);
        }

        function renderGraph(data) {
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg.selectAll("*").remove();
            
            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .selectAll("line")
                .data(data.links)
                .join("line")
                .attr("class", "link");

            const node = svg.append("g")
                .selectAll("g")
                .data(data.nodes)
                .join("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("click", (event, d) => inspectNode(d));

            node.append("circle")
                .attr("r", 8)
                .attr("fill", d => {
                    if (d.type === 'symbol') return '#00f3ff';
                    if (d.type === 'intent') return '#ffb000';
                    if (d.type === 'finding') return '#ff0055';
                    return '#888';
                });

            node.append("text")
                .attr("x", 12)
                .attr("y", 4)
                .attr("fill", "#fff")
                .text(d => d.label);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        function inspectNode(d) {
            document.getElementById("welcome-msg").classList.remove("active");
            document.getElementById("node-inspector").classList.add("active");
            
            const tag = document.getElementById("node-tag");
            tag.innerText = d.type.toUpperCase();
            tag.setAttribute("class", `tag tag-${d.type}`);
            
            document.getElementById("node-id").innerText = d.id;
            
            const contentRow = document.getElementById("prop-content-row");
            const contentVal = document.getElementById("node-content");
            
            if (d.properties.content || d.properties.message) {
                contentRow.style.display = "block";
                contentVal.innerText = d.properties.content || d.properties.message;
            } else {
                contentRow.style.display = "none";
            }
            
            document.getElementById("node-meta").innerText = JSON.stringify(d.properties, null, 2);
        }

        loadData();
    </script>
</body>
</html>
